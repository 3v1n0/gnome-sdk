name: gnome-3-28-1804-sdk
version: git
version-script: |
  echo $(git describe --tags).$(git describe --always)
summary: Shared GNOME 3.28 Ubuntu stack
description: |
 This snap contains only the necessary libraries required by
 GNOME applications.

confinement: strict
grade: stable
base: core18

# the recommended mountpoint for that content is /gnome-platform
slots:
    gnome-3.28-1804:
      interface: content
      read:
        - /

parts:
  last:
    # Ensure that this part is always staged last
    after:
      - meson
      - vala
      - gobject-introspection
      - cairo
      - harfbuzz
      - pango
      - atk
      - at-spi2-core
      - at-spi2-atk
      - epoxy
      - gdk-pixbuf
      - gtk
      - gee
      - glib
      - libcanberra
      - json-glib
      - gsettings-desktop-schemas
      - gnome-desktop
    plugin: nil
    override-build: |
      set -eux
      snapcraftctl build
      SCANNER=$SNAPCRAFT_STAGE/usr/bin/g-ir-scanner
      mv $SCANNER.orig $SCANNER
      cd $SNAPCRAFT_STAGE/usr/lib
      for PC in $(find . -name *.pc)
      do
        sed -i 's#prefix=$SNAPCRAFT_STAGE#prefix=#' $PC
      done
  #libtool:
  #  plugin: autotools
  #  source: https://git.savannah.gnu.org/git/libtool.git
  #  configflags: [ --prefix=/usr ]
  #  build-packages:
  #    - file
  #    - automake
  #    - autoconf
  #    - autotools-dev
  #    - help2man
  #    - texinfo
  #    - zlib1g-dev
  #    - gnulib
  meson:
    plugin: python
    source: https://github.com/mesonbuild/meson.git
    source-tag: 0.47.2
    build-packages:
      - ninja-build
  vala:
    after: [gobject-introspection]
    plugin: autotools
    source: https://github.com/GNOME/vala.git
    source-tag: '0.40.0'
    # Once the 0.40 branch exists, we should track the branch rather than the tag
    #source-branch: 0.40
    configflags: [ --prefix=/usr ]
    build-packages:
      - bison
      - flex
      - help2man
      - xsltproc
      - libdbus-1-dev
      - dbus
      - valac
      - libgraphviz-dev
  cairo:
    after: [glib]
    source: git://anongit.freedesktop.org/git/cairo
    source-branch: '1.14'
    plugin: autotools
    configflags:
      - --prefix=/usr
      - --enable-pdf
      - --enable-ps
      - --enable-xlib
      - --enable-png
      - --enable-tee
      - --enable-svg
      - --enable-xcb
      - --enable-perf-utils
      - --disable-silent-rules
      - --disable-maintainer-mode
    build-packages:
      - libfontconfig1-dev
      - libfreetype6-dev
      - libxrender-dev
      - libx11-dev
      - libxext-dev
      - libpng-dev
      - libsm-dev
      - xutils-dev
      - libxt-dev
      - libpixman-1-dev
      - libxcb1-dev
      - libxcb-render0-dev
      - libxcb-shm0-dev
      - zlib1g-dev
      - liblzo2-dev
  gobject-introspection:
    after: [glib, cairo]
    source: https://gitlab.gnome.org/GNOME/gobject-introspection.git
    source-branch: gnome-3-28
    plugin: autotools
    configflags: [ --prefix=/usr, --with-python=python3 ]
    override-build: |
      set -eux
      snapcraftctl build
      SCANNER=$SNAPCRAFT_PART_INSTALL/usr/bin/g-ir-scanner
      mkdir -p $SNAPCRAFT_STAGE/usr/bin
      cp $SCANNER $SNAPCRAFT_STAGE/usr/bin/g-ir-scanner.orig
      sed -i 's#/usr/lib#$SNAPCRAFT_STAGE/usr/lib#' $SCANNER
      sed -i 's#/usr/share#$SNAPCRAFT_STAGE/usr/share#' $SCANNER
      PKGCONFIG_BUILD=$SNAPCRAFT_STAGE/pkgconfig-build
      mkdir -p $PKGCONFIG_BUILD
      PC=gobject-introspection-1.0.pc
      SRC=$SNAPCRAFT_PART_INSTALL/usr/lib/pkgconfig/$PC
      DST=$PKGCONFIG_BUILD/$PC
      cp $SRC $DST
      sed -i 's#^prefix=#prefix=$SNAPCRAFT_STAGE#' $DST
    build-packages:
      - python3-dev
      - libffi-dev
      - python3-mako
      - bison
      - flex
  atk:
    after: [glib]
    source: https://gitlab.gnome.org/GNOME/atk.git
    source-branch: gnome-3-28
    plugin: autotools
    configflags: [ --prefix=/usr ]
  at-spi2-core:
    after: [glib, gobject-introspection, meson]
    source: https://gitlab.gnome.org/GNOME/at-spi2-core.git
    source-tag: AT_SPI2_CORE_2_28_0
    plugin: meson
    meson-parameters: [ --prefix=/usr ]
    override-build: |
      set -eux
      snapcraftctl build
      PKGCONFIG_BUILD=$SNAPCRAFT_STAGE/pkgconfig-build
      mkdir -p $PKGCONFIG_BUILD
      PC=atspi-2.pc
      SRC=$SNAPCRAFT_PART_INSTALL/usr/lib/$(gcc -print-multiarch)/pkgconfig/$PC
      DST=$PKGCONFIG_BUILD/$PC
      cp $SRC $DST
      sed -i 's#libdir=#libdir=$SNAPCRAFT_STAGE#' $DST
      sed -i 's#includedir=#includedir=$SNAPCRAFT_STAGE#' $DST
    build-packages:
      - libdbus-1-dev
      - libxkbcommon-x11-dev
      - libxkbcommon-dev
      - libxtst-dev
  at-spi2-atk:
    after: [glib, at-spi2-core, atk, meson]
    source: https://gitlab.gnome.org/GNOME/at-spi2-atk.git
    source-branch: gnome-3-26 # there is no gnome-3-28 branch yet
    plugin: meson
    meson-parameters: [ --prefix=/usr ]
    override-build: |
      set -eux
      snapcraftctl build
      PKGCONFIG_BUILD=$SNAPCRAFT_STAGE/pkgconfig-build
      mkdir -p $PKGCONFIG_BUILD
      PC=atk-bridge-2.0.pc
      SRC=$SNAPCRAFT_PART_INSTALL/usr/lib/$(gcc -print-multiarch)/pkgconfig/$PC
      DST=$PKGCONFIG_BUILD/$PC
      cp $SRC $DST
      sed -i 's#libdir=#libdir=$SNAPCRAFT_STAGE#' $DST
      sed -i 's#includedir=#includedir=$SNAPCRAFT_STAGE#' $DST
    build-packages:
      - libdbus-1-dev
      - libdbus-glib-1-dev
      - libxml2-dev
      - libx11-dev
  gdk-pixbuf:
    after: [glib, gobject-introspection]
    source: https://gitlab.gnome.org/GNOME/gdk-pixbuf.git
    source-tag: 2.38.0 # there is no gdk-pixbuf-2-38 branch yet
    plugin: meson
    meson-parameters: [ --prefix=/usr ]
    override-build: |
      set -eux
      snapcraftctl build
      PKGCONFIG_BUILD=$SNAPCRAFT_STAGE/pkgconfig-build
      mkdir -p $PKGCONFIG_BUILD
      PC=gdk-pixbuf-2.0.pc
      SRC=$SNAPCRAFT_PART_INSTALL/usr/lib/$(gcc -print-multiarch)/pkgconfig/$PC
      DST=$PKGCONFIG_BUILD/$PC
      cp $SRC $DST
      sed -i 's#libdir=#libdir=$SNAPCRAFT_STAGE#' $DST
      sed -i 's#includedir=#includedir=$SNAPCRAFT_STAGE#' $DST
    build-packages:
      - libx11-dev
      - libpng-dev
      - libjpeg-dev
      - libtiff-dev
  epoxy:
    after: [glib]
    source: https://github.com/anholt/libepoxy.git
    plugin: meson
    meson-parameters: [ --prefix=/usr ]
    build-packages:
      - xutils-dev
      - libx11-dev
      - libgl1-mesa-dev
      - libegl1-mesa-dev
  gtk:
    after: [glib, cairo, pango, gobject-introspection, gdk-pixbuf, json-glib, atk, at-spi2-atk]
    source: https://gitlab.gnome.org/GNOME/gtk.git
    source-branch: gtk-3-22
    plugin: autotools
    configflags: [ --prefix=/usr ]
    build-packages:
      - libtool
      - gtk-doc-tools
      - gettext
      - dbus-x11
      - libegl1-mesa-dev
      - libepoxy-dev
      - libwayland-dev
      - libxkbcommon-dev
      - libx11-dev
      - libxext-dev
      - libxi-dev
      - libxrandr-dev
      - libxt-dev
      - libxrender-dev
      - libxft-dev
      - libxcursor-dev
      - libxcomposite-dev
      - libxdamage-dev
      - libxkbfile-dev
      - libxinerama-dev
      - libxfixes-dev
      - x11proto-xext-dev
      - libcups2-dev
      - libcolord-dev
      - librest-dev
      - xvfb
  gee: 
    after: [vala, gobject-introspection]
    source: https://gitlab.gnome.org/GNOME/libgee.git
    source-tag: '0.20.1'
    # Once the 0.20 branch exists, we should track the branch rather than the tag
    #source-branch: 0.20
    configflags: [ --prefix=/usr ]
    plugin: autotools
    build-packages:
      - autoconf-archive
  glib: 
    source: https://gitlab.gnome.org/GNOME/glib.git
    source-branch: glib-2-56
    configflags: [ --prefix=/usr ]
    plugin: autotools
    build-packages:
      - automake
      - autoconf
      - autotools-dev
      - libtool
      - libmount-dev
  harfbuzz:
    after: [glib, cairo, gobject-introspection]
    source: git://anongit.freedesktop.org/git/harfbuzz
    source-tag: '1.7.6'
    plugin: autotools
    configflags:
      - --prefix=/usr
      - --with-graphite2=yes
      - --enable-introspection
      - --with-gobject
    build-packages:
      - libfreetype6-dev
      - libicu-dev
      - libgraphite2-dev
      - ragel
    override-build: |
      set -eux
      snapcraftctl build
      PKGCONFIG_BUILD=$SNAPCRAFT_STAGE/pkgconfig-build
      mkdir -p $PKGCONFIG_BUILD
      PC=harfbuzz.pc
      SRC=$SNAPCRAFT_PART_INSTALL/usr/lib/pkgconfig/$PC
      DST=$PKGCONFIG_BUILD/$PC
      cp $SRC $DST
      sed -i 's#libdir=#libdir=$SNAPCRAFT_STAGE#' $DST
      sed -i 's#includedir=#includedir=$SNAPCRAFT_STAGE#' $DST
  pango:
    after: [glib, cairo, harfbuzz]
    source: https://gitlab.gnome.org/GNOME/pango.git
    #source-tag: '1.42.0'
    plugin: meson
    meson-parameters: [ --prefix=/usr ]
    build-packages:
      - libfreetype6-dev
      - libfontconfig1-dev
      - libx11-dev
      - libxft-dev
      - libxrender-dev
      - libxt-dev
      - libfribidi-dev
      - libthai-dev
    override-build: |
      set -eux
      snapcraftctl build
      PKGCONFIG_BUILD=$SNAPCRAFT_STAGE/pkgconfig-build
      mkdir -p $PKGCONFIG_BUILD
      PCS="pango.pc pangocairo.pc pangoxft.pc pangoft2.pc"
      for PC in $PCS
      do
        SRC=$SNAPCRAFT_PART_INSTALL/usr/lib/$(gcc -print-multiarch)/pkgconfig/$PC
        DST=$PKGCONFIG_BUILD/$PC
        cp $SRC $DST
        sed -i 's#libdir=#libdir=$SNAPCRAFT_STAGE#' $DST
        sed -i 's#includedir=#includedir=$SNAPCRAFT_STAGE#' $DST
      done
  libcanberra: 
    after: [glib, gtk]
    source: git://git.0pointer.net/libcanberra.git
    configflags: [ --prefix=/usr ]
    plugin: autotools
    build-packages:
      - libasound2-dev
      - libvorbis-dev
      - libx11-dev
      - libtdb-dev
      - libpulse-dev
      - libgstreamer1.0-dev
  json-glib: 
    after: [glib, meson]
    source: https://gitlab.gnome.org/GNOME/json-glib.git
    source-branch: json-glib-1-4
    plugin: meson
    meson-parameters: [ --prefix=/usr ]
  gsettings-desktop-schemas:
    after: [glib, gobject-introspection]
    source: https://gitlab.gnome.org/GNOME/gsettings-desktop-schemas.git
    source-branch: gnome-3-28
    plugin: autotools
    configflags: [ --prefix=/usr ]
    build-packages:
      - intltool
      - gnome-common
  gnome-desktop:
    after: [glib, gobject-introspection, gdk-pixbuf, gtk, gsettings-desktop-schemas]
    source: https://gitlab.gnome.org/GNOME/gnome-desktop.git
    source-branch: gnome-3-28
    plugin: autotools
    configflags: [ --prefix=/usr ]
    build-packages:
      - iso-codes
      - libgl1-mesa-dev
      - libseccomp-dev
      - libudev-dev
      - libx11-dev
      - libxml2-dev
      - xkb-data
      - yelp-tools
